<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Initializing the USART Driver</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Doc-O-Matic" />
    <meta name="save" content="history" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <link rel="STYLESHEET" href="default.css" type="text/css" />

<script type="text/javascript" src="scripts.js"></script>
</head>
<body class="Element700" onload="onBodyLoad();" onmousedown="onBodyMouseDown();">
<div id="persistenceDiv" style="display:none; behavior:url(#default#userData);"></div>

<!-- Begin Popups -->

<!-- End Popups -->

<!-- Begin Page Header -->
<div class="Element710" id="areafixed">
<div class="Element94">
<a href="16811.html">Volume V: MPLAB Harmony Framework Reference</a> &gt; <a href="13069.html">Driver Libraries Help</a> &gt; <a href="27174.html">USART Driver Library</a> &gt; <a href="08909.html">Using the Library</a> &gt; <a href="08902.html">How the Library Works</a> &gt; <a href="08903.html">Initializing the USART Driver</a></div>
<div class="Element92">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element1">
MPLAB Harmony Help</div>
</td><td width="25%">
<div class="Element2">
<a href="contents.htm">Contents</a> | <a href="idx.html">Index</a> | <a href="04300.html">Home</a></div>
</td><td width="25%">
<div class="Element90">
<a href="08902.html">Previous</a> | <a href="08902.html">Up</a> | <a href="08907.html">Next</a></div>
</td><td width="25%">
<div class="Element96">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: DRV USART Initializing the USART Driver Topic Title: Initializing the USART Driver)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com">Microchip Support</a></div>
</td></tr></table><div class="Element5">
Initializing the USART Driver</div>
</div>
</div>

<!-- End Page Header -->

<!-- Begin Client Area -->
<div class="Element720" id="areascroll">
<div class="Element721">

<!-- Begin Page Content -->
<div class="Element58">
<a name="4465736372697074696F6E"></a><div class="Element11">
<div class="Element10">
<p class="Element10">
The USART Driver must be configured and initialized for clients to be able to open the driver. The driver build time configuration is defined by the configuration macros. Refer to the <a href="08892.html">Building the Library</a> section for the location of and more information on the various configuration macros and how these macros should be designed. The driver initialization is configured through the DRV_USART_INIT data structure that is passed to the <a href="11493.html">DRV_USART_Initialize</a> function. The initialization parameters include the USART baud, the USART Peripheral, USART interrupts and read queue and write queue sizes (which are applicable only when buffer queue data transfer is used). The following code shows an example of initializing the USART driver for 300 bps and uses USART2. If the driver is configured for Interrupt mode of operation, the priority of the USART interrupts needs to be specified. </p><div class="Element170">
<a href="#" onclick="CopyElementToClipboard('code01181');">Copy Code</a></div>
<div class="Element13"><div class="Element12" id="code01181"><pre class="Element12">  <i><span style="color: #008000">/* The following code shows an example of designing the
   * DRV_USART_INIT data structure. It also shows how an example
   * usage of the DRV_USART_Initialize() function and how Interrupt
   * System Service routines are used to set USART Interrupt
   * priority. */</span></i>

    DRV_USART_INIT usartInit;
    SYS_MODULE_OBJ usartModule1;

    <i><span style="color: #008000">/* Set the baud to 300 */</span></i>
    usartInit.baud = 300;

    <i><span style="color: #008000">/* Auto Baud detection or Stop Idle is not needed */</span></i>
    usartInit.flags = DRV_USART_INIT_FLAG_NONE;

    <i><span style="color: #008000">/* Handshaking is not needed */</span></i>
    usartInit.handshake = DRV_USART_HANDSHAKE_NONE;

    <i><span style="color: #008000">/* USART Error Interrupt source for this USART
     * driver instance. Note that INT_SOURCE_USART_2_ERROR
     * value is defined by the Interrupt System Service and
     * is the error interrupt for USART 2*/</span></i>
    usartInit.interruptError = INT_SOURCE_USART_2_ERROR;

    <i><span style="color: #008000">/* USART Receive Interrupt source for this USART
     * driver instance. Note that INT_SOURCE_USART_2_RECEIVE
     * value is defined by the Interrupt System Service and
     * is the error interrupt for USART 2 */</span></i>
    usartInit.interruptReceive = INT_SOURCE_USART_2_RECEIVE;

    <i><span style="color: #008000">/* USART Transmit Interrupt source for this USART
     * driver instance. Note that INT_SOURCE_USART_2_TRANSMIT
     * value is defined by the Interrupt System Service and
     * is the error interrupt for USART 2 */</span></i>
    usartInit.interruptTransmit = INT_SOURCE_USART_2_TRANSMIT;

    <i><span style="color: #008000">/* Line control mode */</span></i>
    usartInit.lineControl = DRV_USART_LINE_CONTROL_8NONE1;

    <i><span style="color: #008000">/* Operation mode is normal. Loopback or addressed is not
     * needed */</span></i>
    usartInit.mode = DRV_USART_OPERATION_MODE_NORMAL;

    <i><span style="color: #008000">/* Peripheral Bus clock frequency at which the USART is
     * operating */</span></i>
    usartInit.brgClock = 80000000;

    <i><span style="color: #008000">/* System module power setting. Typically set to
     * SYS_MODULE_POWER_RUN_FULL */</span></i>
    usartInit.moduleInit.value = SYS_MODULE_POWER_RUN_FULL;

    <i><span style="color: #008000">/* Receive buffer queue size. In this case a maximum of 2
     * receive buffers can be queued. Only applicable if the
     * Buffer Queue Data Transfer Model is included in the
     * application. */</span></i>
    usartInit.queueSizeReceive = 2;

    <i><span style="color: #008000">/* Transmit buffer queue size. In this case a maximum of 3
     * transmit buffers can be queued. Only applicable if the
     * Buffer Queue Data Transfer Model is included in the
     * application. */</span></i>
    usartInit.queueSizeTransmit = 3;

    <i><span style="color: #008000">/* The USART peripheral instance index associated with this
     * driver instance. Note that this value is defined by the
     * USART Peripheral Library */</span></i>
    usartInit.usartID = USART_ID_2;

    <i><span style="color: #008000">/* Initialize USART Driver Instance 0 */</span></i>
    usartModule1 = DRV_USART_Initialize(DRV_USART_0, (SYS_MODULE_INIT*)&amp;usartInit);

    <i><span style="color: #008000">/* The result of the driver initialization can be checked */</span></i>
    <strong><span style="color: #000080">if</span></strong>(SYS_MODULE_OBJ_INVALID == usartModule1)
    {
        <i><span style="color: #008000">/* There was an error in initialization. */</span></i>
    }

    <i><span style="color: #008000">/* If the USART driver is configured for interrupt mode of
     * operation, the interrupt priorities should be configured.
     * Here the Interrupt System Service is used to set the
     * priority to level 4 */</span></i>

    <i><span style="color: #008000">/* Initialize the interrupt system service */</span></i>
    SYS_INT_Initialize();

    <i><span style="color: #008000">/* Set the USART 2 module interrupt priority to 4*/</span></i>
    SYS_INT_VectorPrioritySet(INT_VECTOR_UART2, INT_PRIORITY_LEVEL4);

    <i><span style="color: #008000">/* Set the USART 2 module interrupt sub-priority to 0*/</span></i>
    SYS_INT_VectorSubprioritySet(INT_VECTOR_UART2, INT_SUBPRIORITY_LEVEL0);

    <i><span style="color: #008000">/* Enable global interrupt */</span></i>
    SYS_INT_Enable();</pre></div></div>
<p class="Element10">
The USART Driver can be configured to transfer data through the DMA. In such a case, the DMA channels to be used for USART transmit and receive need to be specified. The USART Driver depends on the DMA System Service to access the DMA module. The DMA channels to be used for transmit and receive transfers should be specified in the DRV_USART_INIT data structure.&nbsp;</p>
<p class="Element10">
The following code shows an example of using the USART Driver initialization to use DMA for transferring data. The code also shows example initialization of the DMA System Service. </p><div class="Element170">
<a href="#" onclick="CopyElementToClipboard('code01182');">Copy Code</a></div>
<div class="Element13"><div class="Element12" id="code01182"><pre class="Element12">  <i><span style="color: #008000">/* The following code shows an example of designing the
   * DRV_USART_INIT data structure. It also shows how an example
   * usage of the DRV_USART_Initialize() function and how Interrupt
   * System Service routines are used to set USART Interrupt
   * priority. */</span></i>

    DRV_USART_INIT usartInit;
    SYS_DMA_INIT dmaInit;
    SYS_MODULE_OBJ usartModule1;
    SYS_MODULE_OBJ dmaModule;

    <i><span style="color: #008000">/* Set the baud to 300 */</span></i>
    usartInit.baud = 300;

    <i><span style="color: #008000">/* Auto Baud detection or Stop Idle is not needed */</span></i>
    usartInit.flags = DRV_USART_INIT_FLAG_NONE;

    <i><span style="color: #008000">/* Handshaking is not needed */</span></i>
    usartInit.handshake = DRV_USART_HANDSHAKE_NONE;

    <i><span style="color: #008000">/* USART Error Interrupt source for this USART
     * driver instance. Note that INT_SOURCE_USART_2_ERROR
     * value is defined by the Interrupt System Service and
     * is the error interrupt for USART2*/</span></i>
    usartInit.interruptError = INT_SOURCE_USART_2_ERROR;

    <i><span style="color: #008000">/* USART Receive Interrupt source for this USART
     * driver instance. Note that INT_SOURCE_USART_2_RECEIVE
     * value is defined by the Interrupt System Service and
     * is the receive interrupt for USART2 */</span></i>
    usartInit.interruptReceive = INT_SOURCE_USART_2_RECEIVE;

    <i><span style="color: #008000">/* USART Transmit Interrupt source for this USART
     * driver instance. Note that INT_SOURCE_USART_2_TRANSMIT
     * value is defined by the Interrupt System Service and
     * is the transmit interrupt for USART2 */</span></i>
    usartInit.interruptTransmit = INT_SOURCE_USART_2_TRANSMIT;

    <i><span style="color: #008000">/* Line control mode */</span></i>
    usartInit.lineControl = DRV_USART_LINE_CONTROL_8NONE1;

    <i><span style="color: #008000">/* Operation mode is normal. Loopback or addressed is not
     * needed */</span></i>
    usartInit.mode = DRV_USART_OPERATION_MODE_NORMAL;

    <i><span style="color: #008000">/* Peripheral Bus clock frequency at which the USART is
     * operating */</span></i>
    usartInit.brgClock = 80000000;

    <i><span style="color: #008000">/* System module power setting. Typically set to
     * SYS_MODULE_POWER_RUN_FULL */</span></i>
    usartInit.moduleInit.value = SYS_MODULE_POWER_RUN_FULL;

    <i><span style="color: #008000">/* Receive buffer queue size. In this case a maximum of 2
     * receive buffers can be queued. Only applicable if the
     * Buffer Queue Data Transfer Model is included in the
     * application. */</span></i>
    usartInit.queueSizeReceive = 2;

    <i><span style="color: #008000">/* Transmit buffer queue size. In this case a maximum of 3
     * transmit buffers can be queued. Only applicable if the
     * Buffer Queue Data Transfer Model is included in the
     * application. */</span></i>
    usartInit.queueSizeTransmit = 3;

    <i><span style="color: #008000">/* The USART peripheral instance index associated with this
     * driver instance. Note that this value is defined by the
     * USART Peripheral Library */</span></i>
    usartInit.usartID = USART_ID_2;

    <i><span style="color: #008000">/* Use DMA channel 1 for transmit. If transmit via DMA is
     * not required, set this to DMA_CHANNEL_NONE. These values
     * are defined by the DMA System Service. */</span></i>
    usartInit.dmaChannelTransmit = DMA_CHANNEL_1;

    <i><span style="color: #008000">/* Use DMA channel 2 for receive. If receive via DMA is
     * not required, set this to DMA_CHANNEL_NONE. These values
     * are defined by the DMA System Service. */</span></i>
    usartInit.dmaChannelReceive = DMA_CHANNEL_2;

    <i><span style="color: #008000">/* Set the interrupt source for the Transmit DMA channel.
     * This parameter is ignored if the dmaChannelTransmit
     * parameter is set to DMA_CHANNEL_NONE. */</span></i>
    usartInit.dmaInterruptTransmit = INT_SOURCE_DMA_1;

    <i><span style="color: #008000">/* Set the interrupt source for the Receive DMA channel.
     * This parameter is ignored if the dmaChannelReceive
     * parameter is set to DMA_CHANNEL_NONE. */</span></i>
    usartInit.dmaInterruptReceive = INT_SOURCE_DMA_2;

    <i><span style="color: #008000">/********* End of DRV_USART_INIT Initialization *************/</span></i>


    <i><span style="color: #008000">/* If the USART driver is configured for interrupt mode of
     * operation, the interrupt priorities should be configured.
     * Here the Interrupt System Service is used to set the
     * priority to level 4 */</span></i>

    <i><span style="color: #008000">/* Initialize the interrupt system service */</span></i>
    SYS_INT_Initialize();

    <i><span style="color: #008000">/* Set the USART 2 module interrupt priority to 4*/</span></i>
    SYS_INT_VectorPrioritySet(INT_VECTOR_UART2, INT_PRIORITY_LEVEL4);

    <i><span style="color: #008000">/* Set the USART 2 module interrupt sub-priority to 0*/</span></i>
    SYS_INT_VectorSubprioritySet(INT_VECTOR_UART2, INT_SUBPRIORITY_LEVEL0);

    <i><span style="color: #008000">/* Set the DMA 1 channel interrupt priority to 4*/</span></i>
    SYS_INT_VectorPrioritySet(INT_VECTOR_DMA1, INT_PRIORITY_LEVEL4);

    <i><span style="color: #008000">/* Set the DMA 1 channel interrupt sub-priority to 0*/</span></i>
    SYS_INT_VectorSubprioritySet(INT_VECTOR_DMA1, INT_SUBPRIORITY_LEVEL0);

    <i><span style="color: #008000">/* Set the DMA 2 channel interrupt priority to 4*/</span></i>
    SYS_INT_VectorPrioritySet(INT_VECTOR_DMA2, INT_PRIORITY_LEVEL4);

    <i><span style="color: #008000">/* Set the DMA 2 channel interrupt sub-priority to 0*/</span></i>
    SYS_INT_VectorSubprioritySet(INT_VECTOR_DMA2, INT_SUBPRIORITY_LEVEL0);

    <i><span style="color: #008000">/* Enable global interrupt */</span></i>
    SYS_INT_Enable();

    <i><span style="color: #008000">/* This is the DMA System Service Initialization */</span></i>
    dmaInit.sidl = SYS_DMA_SIDL_DISABLE;
    dmaModule = SYS_DMA_Initialize((SYS_MODULE_INIT*)&amp;dmaInit);

    <i><span style="color: #008000">/* The result of the DMA System Service initialization can be checked */</span></i>
    <strong><span style="color: #000080">if</span></strong>(SYS_MODULE_OBJ_INVALID == dmaModule)
    {
        <i><span style="color: #008000">/* DMA System Service initialization was not successful */</span></i>
    }

    <i><span style="color: #008000">/* Initialize USART Driver Instance 0 */</span></i>
    usartModule1 = DRV_USART_Initialize(DRV_USART_0, (SYS_MODULE_INIT*)&amp;usartInit);

    <i><span style="color: #008000">/* The result of the driver initialization can be checked */</span></i>
    <strong><span style="color: #000080">if</span></strong>(SYS_MODULE_OBJ_INVALID == usartModule1)
    {
        <i><span style="color: #008000">/* There was an error in initialization. */</span></i>
    }</pre></div></div>
</div>
</div>
</div>
<!-- End Page Content -->

<!-- Begin Page Footer -->
<div class="Element95">
<a href="16811.html">Volume V: MPLAB Harmony Framework Reference</a> &gt; <a href="13069.html">Driver Libraries Help</a> &gt; <a href="27174.html">USART Driver Library</a> &gt; <a href="08909.html">Using the Library</a> &gt; <a href="08902.html">How the Library Works</a> &gt; <a href="08903.html">Initializing the USART Driver</a></div>
<div class="Element93">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="100%">
<div class="Element3">
 MPLAB Harmony Help</div>
</td></tr><tr><td width="100%">
<div class="Element4">
<a href="contents.htm">Contents</a> | <a href="idx.html">Index</a> | <a href="04300.html">Home</a></div>
</td></tr><tr><td width="100%">
<div class="Element97">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: DRV USART Initializing the USART Driver Topic Title: Initializing the USART Driver)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com">Microchip Support</a></div>
</td></tr></table></div>

<!-- End Page Footer -->
</div>
</div>

<!-- End Client Area -->
</body></html>