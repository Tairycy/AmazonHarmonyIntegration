<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Enhanced Buffer Slave Mode</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="generator" content="Doc-O-Matic" />
    <meta name="save" content="history" />
    <meta http-equiv="Content-Style-Type" content="text/css" />
    <link rel="STYLESHEET" href="default.css" type="text/css" />

<script type="text/javascript" src="scripts.js"></script>
</head>
<body class="Element700" onload="onBodyLoad();" onmousedown="onBodyMouseDown();">
<div id="persistenceDiv" style="display:none; behavior:url(#default#userData);"></div>

<!-- Begin Popups -->

<!-- End Popups -->

<!-- Begin Page Header -->
<div class="Element710" id="areafixed">
<div class="Element94">
<a href="16811.html">Volume V: MPLAB Harmony Framework Reference</a> &gt; <a href="17367.html">Peripheral Libraries Help</a> &gt; <a href="23143.html">SPI Peripheral Library</a> &gt; <a href="18024.html">Using the Library</a> &gt; <a href="18002.html">How the Library Works</a> &gt; <a href="17995.html">Enhanced Buffer SPI Mode</a> &gt; <a href="17994.html">Enhanced Buffer Slave Mode</a></div>
<div class="Element92">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="25%">
<div class="Element1">
MPLAB Harmony Help</div>
</td><td width="25%">
<div class="Element2">
<a href="contents.htm">Contents</a> | <a href="idx.html">Index</a> | <a href="04300.html">Home</a></div>
</td><td width="25%">
<div class="Element90">
<a href="17993.html">Previous</a> | <a href="17995.html">Up</a> | <a href="17999.html">Next</a></div>
</td><td width="25%">
<div class="Element96">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: PLIB SPI Enhanced Buffer Slave Mode Topic Title: Enhanced Buffer Slave Mode)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com">Microchip Support</a></div>
</td></tr></table><div class="Element5">
Enhanced Buffer Slave Mode</div>
</div>
</div>

<!-- End Page Header -->

<!-- Begin Client Area -->
<div class="Element720" id="areascroll">
<div class="Element721">

<!-- Begin Page Content -->
<div class="Element58">
<a name="4465736372697074696F6E"></a><div class="Element11">
<div class="Element10">
<div class="Element15">
Slave Select Synchronization</div>
<p class="Element10">
The Slave Select pin allows a Synchronous Slave mode. If the slave select enabled (<a href="20795.html">PLIB_SPI_PinEnable</a>), transmission and reception is enabled in Slave mode only if the /SS pin is driven to a low state. The port output or other peripheral outputs must not be driven to allow the /SS pin to function as an input. If the slave select is enabled and the /SS pin is driven high, the SDO pin is no longer driven and will tri-state even if the module is in the middle of a transmission. An aborted transmission will be retried the next time the /SS pin is driven low using the data held in the SPI transmit buffer. If the Slave select is disabled (<a href="20794.html">PLIB_SPI_PinDisable</a>), the /SS pin does not affect the module operation in Slave mode.</p><div class="Element15">
SPI Transmit Buffer Full Operation</div>
<p class="Element10">
The function of the SPI transmit buffer full flag (<a href="20807.html">PLIB_SPI_TransmitBufferIsFull</a>) is different in the Slave mode of operation. If Slave select is disabled (<a href="20794.html">PLIB_SPI_PinDisable</a>), the SPI Transmit Buffer Full flag (<a href="20807.html">PLIB_SPI_TransmitBufferIsFull</a>) is set when the last available buffer location is loaded by the user application. It is cleared when the module transfers data from the buffer to SPI status register and a buffer location is available for a CPU write. This is similar to the SPI transmit buffer in Master mode.&nbsp;</p>
<p class="Element10">
If Slave select is enabled (<a href="20795.html">PLIB_SPI_PinEnable</a>), the SPI transmit buffer is set when the last available buffer location is loaded by the user application. However, it is cleared only when the SPI module completes data transmission, leaving a buffer location available for a CPU write. A transmission will be aborted when the /SS pin goes high and may be retried at a later time. Each data word is held in the buffer until all bits are transmitted to the receiver.</p><div class="Element15">
Setup</div>
<p class="Element10">
In Slave mode, data is transmitted and received as the external clock pulses appear on the SCK pin. <a href="20793.html">PLIB_SPI_OutputDataPhaseSelect</a> and <a href="20731.html">PLIB_SPI_ClockPolaritySelect</a> determine upon which edge of the clock data transmission occurs. The rest of the operation of the module is identical to that of Enhanced Buffer Master mode.&nbsp;</p>
<p class="Element10">
<strong>Example: Enhanced Slave Mode communication</strong> <strong>Setup</strong> &nbsp;</p><div class="Element170">
<a href="#" onclick="CopyElementToClipboard('code03270');">Copy Code</a></div>
<div class="Element13"><div class="Element12" id="code03270"><pre class="Element12"><strong><span style="color: #000080">#define</span></strong> MY_SPI_ID            SPI_ID_1
<strong><span style="color: #000080">#define</span></strong> PERIPHERAL_BUS_CLK   80000000
<strong><span style="color: #000080">#define</span></strong> SPI_BAUD_RATE        10000000

<i><span style="color: #008000">//Disable SPI</span></i>
PLIB_SPI_Disable(MY_SPI_ID);

<i><span style="color: #008000">// Optional:  Clear SPI interrupts and status flag.</span></i>

<i><span style="color: #008000">//clear SPI buffer</span></i>
PLIB_SPI_BufferClear (MY_SPI_ID);

<i><span style="color: #008000">// Configure General SPI Options</span></i>
PLIB_SPI_StopInIdleDisable(MY_SPI_ID);
PLIB_SPI_CommunicationWidthSelect(MY_SPI_ID, SPI_COMMUNICATION_WIDTH_16BITS);

<i><span style="color: #008000">// SMP must be cleared when SPI is used in Slave mode</span></i>
PLIB_SPI_PinEnable(MY_SPI_ID,SPI_PIN_DATA_OUT|SPI_PIN_SLAVE_SELECT);
PLIB_SPI_InputSamplePhaseSelect(MY_SPI_ID,SPI_INPUT_SAMPLING_PHASE_IN_MIDDLE);
PLIB_SPI_ClockPolaritySelect(MY_SPI_ID, SPI_INPUT_SAMPLING_PHASE_AT_END);<i><span style="color: #008000">//clock polarity and edge is subject to change ...</span></i>
PLIB_SPI_OutputDataPhaseSelect(MY_SPI_ID, SPI_OUTPUT_DATA_PHASE_ON_ACTIVE_TO_IDLE_CLOCK);<i><span style="color: #008000">// ... based on your communication mode.</span></i>

PLIB_SPI_BaudRateSet(MY_SPI_ID,PERIPHERAL_BUS_CLK,SPI_BAUD_RATE);
PLIB_SPI_SlaveEnable(MY_SPI_ID);
PLIB_SPI_FramedCommunicationDisable(MY_SPI_ID);
PLIB_SPI_FIFOEnable(MY_SPI_ID);

<i><span style="color: #008000">// Optional:  Enable interrupts.</span></i>

<i><span style="color: #008000">// Enable the module</span></i>
PLIB_SPI_Enable(MY_SPI_ID);
</pre></div></div>
<p class="Element10">
<strong>Transmission and Receive:</strong>&nbsp;</p>
<p class="Element10">
Both data to be transmitted and data that is received are respectively written into, or read from, the SPI buffer (<a href="20728.html">PLIB_SPI_BufferWrite</a>/<a href="20725.html">PLIB_SPI_BufferRead</a>). The remainder of the operation of the module is identical to that of Enhanced Buffer Master mode.&nbsp;</p>
<p class="Element10">
<strong>Example: Enhanced Slave Mode communication</strong> <strong>Receive</strong> &nbsp;</p><div class="Element170">
<a href="#" onclick="CopyElementToClipboard('code03271');">Copy Code</a></div>
<div class="Element13"><div class="Element12" id="code03271"><pre class="Element12"><strong><span style="color: #000080">#define</span></strong> MY_SPI_ID   SPI_ID_1

uint16_t data;

<strong><span style="color: #000080">if</span></strong>(PLIB_SPI_ReceiverHasOverflowed(MY_SPI_ID))
{
   <i><span style="color: #008000">// error</span></i>
   PLIB_SPI_ReceiverOverflowClear(MY_SPI_ID);<i><span style="color: #008000">// clear overflow</span></i>
   data = PLIB_SPI_BufferRead (MY_SPI_ID);
}
<strong><span style="color: #000080">else</span></strong> <strong><span style="color: #000080">if</span></strong> (!PLIB_SPI_ReceiverBufferIsFull(MY_SPI_ID))
{
   <i><span style="color: #008000">// error</span></i>
}
<strong><span style="color: #000080">else</span></strong>
{
   data = PLIB_SPI_BufferRead (MY_SPI_ID);       <i><span style="color: #008000">// read data</span></i>
   <strong><span style="color: #000080">while</span></strong>(PLIB_SPI_TransmitBufferIsFull(MY_SPI_ID));
   PLIB_SPI_BufferWrite(MY_SPI_ID, data);                <i><span style="color: #008000">// send back</span></i>
}
</pre></div></div>
<div class="Element63">
<div class="TableDiv">
<table cellspacing="0" class="Table0">
<tr>
<td class="Element67" valign="top" width="10%" style="border:none;">
<div class="Element68">
<img src="Note Icon.png" border="0" alt="" title=""> <strong>Notes:</strong>&nbsp;</div></td><td class="Element67" valign="top" width="90%" style="border:none;">
<div class="Element68">

<ol class="Element630">
<li value="1" class="Element600">Refer to the <strong>&quot;Interrupts&quot;</strong> chapter in the specific device data sheet or the family reference manual section specified in that chapter for details on how to clear and enable the SPI module interrupts and flags.</li>
<li value="2" class="Element600">MY_SPI_ID is the SPI instance selected for use by the application developer.</li>
<li value="3" class="Element600">Not all features are available on all devices. Refer to the <strong>&quot;Serial Peripheral Interface (SPI)&quot;</strong> chapter in the specific device data sheet for availability.</li>
</ol>&nbsp;</div></td></tr></table></div></div>
</div>
</div>
</div>
<!-- End Page Content -->

<!-- Begin Page Footer -->
<div class="Element95">
<a href="16811.html">Volume V: MPLAB Harmony Framework Reference</a> &gt; <a href="17367.html">Peripheral Libraries Help</a> &gt; <a href="23143.html">SPI Peripheral Library</a> &gt; <a href="18024.html">Using the Library</a> &gt; <a href="18002.html">How the Library Works</a> &gt; <a href="17995.html">Enhanced Buffer SPI Mode</a> &gt; <a href="17994.html">Enhanced Buffer Slave Mode</a></div>
<div class="Element93">
<table width="100%" cellspacing="0" cellpadding="0">
<tr><td width="100%">
<div class="Element3">
 MPLAB Harmony Help</div>
</td></tr><tr><td width="100%">
<div class="Element4">
<a href="contents.htm">Contents</a> | <a href="idx.html">Index</a> | <a href="04300.html">Home</a></div>
</td></tr><tr><td width="100%">
<div class="Element97">
<a href="mailto:docerrors@microchip.com&subject=MPLAB Harmony Documentation Feedback (Topic ID: PLIB SPI Enhanced Buffer Slave Mode Topic Title: Enhanced Buffer Slave Mode)&body=Thank you for your feedback! Please include a description of your feedback, and indicate whether you are reporting an an error in the documentation or an enhancement.">Documentation Feedback</a><br> <a href="http://support.microchip.com">Microchip Support</a></div>
</td></tr></table></div>

<!-- End Page Footer -->
</div>
</div>

<!-- End Client Area -->
</body></html>